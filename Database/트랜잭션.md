## 트랜잭션이란?
- 데이터베이스의 **상태를 변화**시키기 위해 수행하는 **작업 단위**
### 상태 변화
- SQL문을 통해 DB에 접근
> SELECT, INSERT, DELETE, UPDATE
### 작업 단위
사용자 A가 사용자 B에게 만원을 송금할 때, 작업은 '출금 + 입금'으로 이루어지며 해당 작업을 **트랜잭션**이라고 함
출금, 입금 두 쿼리문이 모두 성공되어야 하나의 트랜잭션이 완료되는 것 (`Commit`)
두 쿼리문 중 하나라도 실패 시, 모든 쿼리문을 취소하고 이전 상태로 돌아감 (`Rollback`)
## 특징
### ACID
#### Atomicity
- 원자성
- 트랜잭션이 모두 DB에 반영되거나, 혹은 전혀 반영되지 않아야 함
#### Consistency
- 일관성
- 트랜잭션 작업 처리 결과는 선후 처리에 관계없이 항상 일정한 결과를 낳아야 함
#### Isolation
- 독립성
- 둘 이상의 트랜잭션이 동시에 병행 실행될 때, 각 트랜잭션의 연산에 끼어들 수 없음
#### Durability
- 지속성
- 트랜잭션이 성공적으로 완료되었다면, 영구적으로 데이터베이스에 반영되어야 함
## 격리 수준 (Isolation Level)
- 일관성 없는 데이터를 허용하도록 하는 수준
### 필요성
- ACID 특징에 맞게 트랜잭션은 독립적인 수행을 해야 함
- Locking을 통해, 트랜잭션이 DB를 다루는 동안 다른 트랜잭션이 해당 연산에 관여해서는 안됨
- 강제 Locking으로 수많은 트랜잭션을 순서대로 처리할 경우, DB의 성능이 저하됨
- 성능을 높이기 위해 Locking의 범위를 줄일 경우, 잘못된 값이 처리될 가능성이 높아짐
### 일관성 문제
#### 1️⃣ Dirty Read
- 다른 트랜잭션의 중간 처리 작업의 결과를 볼 수 있는 현상
- 트랜잭션이 커밋되기 전에 수정된 데이터를 다른 트랜잭션이 볼 수 있는 현상
- 격리 수준이 `Read Uncommitted` 이하일 때 발생
![](https://i.imgur.com/Ke986Uc.png)
#### 2️⃣ Non-Repetable Read
- 하나의 트랜잭션에서 두 번의 동일한 조회를 했을 때, 서로 다른 결과가 조회되는 현상
- 격리 수준이 `Read Committed` 이하일 때 발생
![](https://i.imgur.com/EZHlgA1.png)
#### 3️⃣ Phantom Read
- 하나의 트랜잭션에서 두 번의 동일한 조회를 했을 때, 없던 데이터가 생기는 현상
![](https://i.imgur.com/9P3gYqI.png)
### 수준
#### Level 0 : Read Uncommitted
- SELECT가 수행되는 동안 해당 데이터에 lock이 걸리지 않음
- 트랜잭션 처리 중이거나, 아직 Commit 되지 않은 데이터를 읽을 수 있음
- DB 일관성 유지 불가능
#### Level 1 : Read Committed
- SELECT가 수행되는 동안 데이터에 lock이 걸림
- 트랜잭션이 수행되는 동안 다른 트랜잭션은 대기
- Commit이 이루어진 데이터만 조회 가능
- 대부분의 SQL 서버가 기본값으로 사용하는 격리 수준
#### Level 2 : Repeatable Read
- 트랜잭션이 완료될 때까지 SELECT 문장이 사용하는 모든 데이터에 lock이 걸림
- 트랜잭션 범위 내에서 조회한 데이터가 항상 동일함
- MYSQL에서 기본값으로 사용하는 격리 수준
#### Level 3 : Serializable
- 읽기 작업에도 공유 잠금을 설정
- 가장 엄격한 격리수준
- 동시처리, 성능 저하
### 격리 수준과 데이터 부정합
![](https://i.imgur.com/NAr8zTN.png)
> 한 트랜잭션이 SELECT하지 않고 있는 컬럼에 대해서는 Lock이 발생하지 않으므로 PhantomRead가 발생할 수 있음